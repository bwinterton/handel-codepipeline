#!/usr/bin/env node
const AWS = require('aws-sdk');
AWS.config.update({region: 'us-west-2'}); //TODO - Generalize this to all regions later
const codepipeline = require('../lib/codepipeline');
const codebuild = require('../lib/codebuild');
const input = require('../lib/input');

console.log("Welcome to the Handel CodePipeline setup wizard");
input.getConfigFiles()
    .then(handelConfigs => {
        let handelFile = handelConfigs.handel;
        let handelCodePipelineFile = handelConfigs.handelCodePipeline;
        let accountConfigs = input.getAccountConfigs(handelCodePipelineFile)
        return codebuild.createCodeBuildProjects(handelCodePipelineFile, handelFile, accountConfigs)
            .then(createdProjects => {
                 return codepipeline.createPipelines(handelCodePipelineFile, handelFile, accountConfigs)
            })
            .then(createdPipelines => {
                for(let accountId in createdPipelines) {
                    console.log(`Created pipeline in ${accountId}`);
                }
            });
       
    })
    .catch(err => {
        console.log(`Error setting up Handel CodePipeline: ${err}`);
        console.log(err); 
    });
