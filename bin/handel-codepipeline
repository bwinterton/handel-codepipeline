#!/usr/bin/env node
const AWS = require('aws-sdk');
AWS.config.update({region: 'us-west-2'}); //TODO - Generalize this to all regions later
const util = require('../create-pipeline/util');
const createWorkers = require('../create-pipeline/create-workers');
const createActions = require('../create-pipeline/create-actions');
const createPipeline = require('../create-pipeline/create-codepipeline');
const input = require('../create-pipeline/input');

console.log("Welcome to the Handel CodePipeline setup wizard");
let handelFilePath = 'handel.yml';
let handelFile = util.loadYamlFile(handelFilePath);
if(!handelFile) {
    console.log(`ERROR: Could not find ${handelFilePath} file in current working directory`);
    process.exit(1);
}

input.getAccountsForEnvs()
    .then(envAccounts => {
        //Load the account-level configuration required by Handel
        return input.getConfigForAccounts(envAccounts);
    })
    .then(accountConfigs => {
        //Create the handel workers in the accounts if necessary
        return createWorkers.createHandelWorkers(accountConfigs)
            .then(stacks => {
                //Create code pipeline action type if not exists
                return createActions.createHandelActions(accountConfigs, stacks)
                    .then(createdActions => {
                        //Create code pipelines with custom action type  
                    })
                    .then(response => {
                        //Register code pipeline with job worker
                    });
            });
    })
    .catch(err => {
        console.log(`Error setting up Handel CodePipeline: ${err}`);
        console.log(err); 
    });
