#!/usr/bin/env node
const AWS = require('aws-sdk');
const input = require('../lib/input');
const winston = require('winston');
const util = require('../lib/util/util');
const lifecycle = require('../lib/lifecycle');

winston.info("Welcome to the Handel CodePipeline setup wizard");

input.getPipelineConfig()
    .then(pipelineConfig => {
        let accountName = pipelineConfig.accountName;
        let accountConfig = util.getAccountConfig(pipelineConfig.accountConfigsPath, accountName);
        AWS.config.update({region: accountConfig.region});
        let handelFile = pipelineConfig.handel;
        let handelCodePipelineFile = pipelineConfig.handelCodePipeline;
        let pipelineToCreate = pipelineConfig.pipelineToCreate;

        lifecycle.validatePipelineSpec(handelFile, handelCodePipelineFile);

        let phaseDeployers = util.getPhaseDeployers();

        return lifecycle.getPhaseSecrets(phaseDeployers, handelCodePipelineFile, pipelineToCreate)
            .then(phasesSecrets => {
                return lifecycle.createPhases(phaseDeployers, handelCodePipelineFile, handelFile, pipelineToCreate, accountConfig, phasesSecrets)
            })
            .then(pipelinePhases => {
                return lifecycle.createPipeline(handelCodePipelineFile, handelFile, pipelineToCreate, accountConfig, pipelinePhases);
            })
            .then(pipeline => {
                winston.info(`Finished creating pipeline in ${accountConfig.account_id}`);
            });
    })
    .catch(err => {
        winston.error(`Error setting up Handel CodePipeline: ${err}`);
        winston.error(err); 
    });