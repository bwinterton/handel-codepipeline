#!/usr/bin/env node
const AWS = require('aws-sdk');
AWS.config.update({region: 'us-west-2'}); //TODO - Generalize this to all regions later
const util = require('../create-pipeline/util/util');
const workers = require('../create-pipeline/workers');
const actions = require('../create-pipeline/actions');
const codepipeline = require('../create-pipeline/codepipeline');
const input = require('../create-pipeline/input');

console.log("Welcome to the Handel CodePipeline setup wizard");
input.getConfigFiles()
    .then(handelConfigs => {
        let handelFile = handelConfigs.handel;
        let handelCodePipelineFile = handelConfigs.handelCodePipeline;
        let accountConfigs = input.getAccountConfigs(handelCodePipelineFile)
        return workers.createHandelWorkers(accountConfigs)
            .then(handelWorkerStacks => {
                //Create code pipeline action type if not exists
                return actions.createHandelActions(accountConfigs, handelWorkerStacks)
                    .then(createdActions => {
                        return codepipeline.createPipelines(handelCodePipelineFile, handelFile, handelWorkerStacks)
                    })
                    .then(createdPipelines => {
                        console.log(createdPipelines);
                        //Register code pipeline with job worker
                    });
            });
    })
    .catch(err => {
        console.log(`Error setting up Handel CodePipeline: ${err}`);
        console.log(err); 
    });
